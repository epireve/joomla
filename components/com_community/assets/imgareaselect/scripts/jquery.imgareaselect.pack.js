(function(a){function f(){return a("<div/>")}var b=Math.abs,c=Math.max,d=Math.min,e=Math.round;a.imgAreaSelect=function(g,h){function bx(b){if(b.parent)(v=a(b.parent)).append(k.add(n));a.extend(h,b);be();if(b.handles!=null){o.remove();o=a([]);S=b.handles?b.handles=="corners"?4:8:0;while(S--)o=o.add(f());o.addClass(h.classPrefix+"-handle").css({position:"absolute",fontSize:0,zIndex:x+1||1});if(!parseInt(o.css("width"))>=0)o.width(5).height(5);if(T=h.borderWidth)o.css({borderWidth:T,borderStyle:"solid"});bw(o,{borderColor1:"border-color",borderColor2:"background-color",borderOpacity:"opacity"})}B=h.imageWidth/t||1;C=h.imageHeight/u||1;if(b.x1!=null){bd(b.x1,b.y1,b.x2,b.y2);b.show=!b.hide}if(b.keys)h.keys=a.extend({shift:1,ctrl:"resize"},b.keys);n.addClass(h.classPrefix+"-outer");l.addClass(h.classPrefix+"-selection");for(S=0;S++<4;)a(m[S-1]).addClass(h.classPrefix+"-border"+S);bw(l,{selectionColor:"background-color",selectionOpacity:"opacity"});bw(m,{borderOpacity:"opacity",borderWidth:"border-width"});bw(n,{outerColor:"background-color",outerOpacity:"opacity"});if(T=h.borderColor1)a(m[0]).css({borderStyle:"solid",borderColor:T});if(T=h.borderColor2)a(m[1]).css({borderStyle:"dashed",borderColor:T});k.append(l.add(m).add(p).add(o));if(a.browser.msie){if(T=n.css("filter").match(/opacity=(\d+)/))n.css("opacity",T[1]/100);if(T=m.css("filter").match(/opacity=(\d+)/))m.css("opacity",T[1]/100)}if(b.hide)bh(k.add(n));else if(b.show&&j){J=true;k.add(n).fadeIn(h.fadeSpeed||0);bg()}I=(R=(h.aspectRatio||"").split(/:/))[0]/R[1];i.add(n).unbind("mousedown",bs);if(h.disable||h.enable===false){k.unbind("mousemove",bi).unbind("mousedown",bk);a(window).unbind("resize",bt)}else{if(h.enable||h.disable===false){if(h.resizable||h.movable)k.mousemove(bi).mousedown(bk);a(window).resize(bt)}if(!h.persistent)i.add(n).mousedown(bs)}h.enable=h.disable=undefined}function bw(a,b){for(var c in b)if(h[c]!==undefined)a.css(b[c],h[c])}function bu(){j=true;bx(h=a.extend({classPrefix:"imgareaselect",movable:true,parent:"body",resizable:true,resizeMargin:10,onInit:function(){},onSelectStart:function(){},onSelectChange:function(){},onSelectEnd:function(){}},h));k.add(n).css({visibility:""});if(h.show){J=true;be();bf();k.add(n).hide().fadeIn(h.fadeSpeed||0)}setTimeout(function(){h.onInit(g,bc())},0)}function bt(){bg(false)}function bs(b){if(b.which!=1||n.is(":animated"))return false;be();z=K=ba(b);A=L=bb(b);a(document).mousemove(bq).mouseup(br);return false}function br(){a(document).unbind("mousemove",bq).unbind("mouseup",br);bh(k.add(n));bd(Z(K),_(L),Z(K),_(L));if(!(this instanceof a.imgAreaSelect)){h.onSelectChange(g,bc());h.onSelectEnd(g,bc())}}function bq(){a(document).unbind("mousemove",bq);be();M=K;N=L;bm();D="";if(!n.is(":visible"))k.add(n).hide().fadeIn(h.fadeSpeed||0);J=true;a(document).unbind("mouseup",br).mousemove(bn).one("mouseup",bj);k.unbind("mousemove",bi);h.onSelectStart(g,bc())}function bp(a){K=c(q,d(z+ba(a),q+t-O.width));L=c(r,d(A+bb(a),r+u-O.height));bo(K,L);a.preventDefault();return false}function bo(b,c){M=(K=b)+O.width;N=(L=c)+O.height;a.extend(O,{x1:Z(K),y1:_(L),x2:Z(M),y2:_(N)});bf();h.onSelectChange(g,bc())}function bn(a){M=/w|e|^$/.test(D)||I?ba(a):X(O.x2);N=/n|s|^$/.test(D)||I?bb(a):Y(O.y2);bm();return false}function bm(){K=d(K,q+t);L=d(L,r+u);if(b(M-K)<E){M=K-E*(M<K||-1);if(M<q)K=q+E;else if(M>q+t)K=q+t-E}if(b(N-L)<F){N=L-F*(N<L||-1);if(N<r)L=r+F;else if(N>r+u)L=r+u-F}M=c(q,d(M,q+t));N=c(r,d(N,r+u));bl(b(M-K)<b(N-L)*I);if(b(M-K)>G){M=K-G*(M<K||-1);bl()}if(b(N-L)>H){N=L-H*(N<L||-1);bl(true)}O={x1:Z(d(K,M)),x2:Z(c(K,M)),y1:_(d(L,N)),y2:_(c(L,N)),width:b(M-K),height:b(N-L)};bf();h.onSelectChange(g,bc())}function bl(a){if(I)if(a){M=c(q,d(q+t,K+b(N-L)*I*(M>K||-1)));N=e(c(r,d(r+u,L+b(M-K)/I*(N>L||-1))));M=e(M)}else{N=c(r,d(r+u,L+b(M-K)/I*(N>L||-1)));M=e(c(q,d(q+t,K+b(N-L)*I*(M>K||-1))));N=e(N)}}function bk(b){if(b.which!=1)return false;be();if(D){a("body").css("cursor",D+"-resize");K=X(O[/w/.test(D)?"x2":"x1"]);L=Y(O[/n/.test(D)?"y2":"y1"]);a(document).mousemove(bn).one("mouseup",bj);k.unbind("mousemove",bi)}else if(h.movable){z=q+O.x1-ba(b);A=r+O.y1-bb(b);k.unbind("mousemove",bi);a(document).mousemove(bp).one("mouseup",function(){h.onSelectEnd(g,bc());a(document).unbind("mousemove",bp);k.mousemove(bi)})}else i.mousedown(b);return false}function bj(b){a("body").css("cursor","");if(h.autoHide||O.width*O.height==0)bh(k.add(n),function(){a(this).hide()});a(document).unbind("mousemove",bn);k.mousemove(bi);h.onSelectEnd(g,bc())}function bi(a){var b=Z(ba(a))-O.x1,c=_(bb(a))-O.y1;if(!W){be();W=true;k.one("mouseout",function(){W=false})}D="";if(h.resizable){if(c<=h.resizeMargin)D="n";else if(c>=O.height-h.resizeMargin)D="s";if(b<=h.resizeMargin)D+="w";else if(b>=O.width-h.resizeMargin)D+="e"}k.css("cursor",D?D+"-resize":h.movable?"move":"");if(p)p.toggle()}function bh(a,b){h.fadeSpeed?a.fadeOut(h.fadeSpeed,b):a.hide()}function bg(a){be();bf(a);K=X(O.x1);L=Y(O.y1);M=X(O.x2);N=Y(O.y2)}function bf(b){if(!J)return;k.css({left:X(O.x1),top:Y(O.y1)}).add(l).width(U=O.width).height(V=O.height);l.add(m).add(o).css({left:0,top:0});m.width(c(U-m.outerWidth()+m.innerWidth(),0)).height(c(V-m.outerHeight()+m.innerHeight(),0));a(n[0]).css({left:q,top:r,width:O.x1,height:u});a(n[1]).css({left:q+O.x1,top:r,width:U,height:O.y1});a(n[2]).css({left:q+O.x2,top:r,width:t-O.x2,height:u});a(n[3]).css({left:q+O.x1,top:r+O.y2,width:U,height:u-O.y2});U-=o.outerWidth();V-=o.outerHeight();switch(o.length){case 8:a(o[4]).css({left:U>>1});a(o[5]).css({left:U,top:V>>1});a(o[6]).css({left:U>>1,top:V});a(o[7]).css({top:V>>1});case 4:o.slice(1,3).css({left:U});o.slice(2,4).css({top:V})}if(b!==false){if(a.imgAreaSelect.keyPress!=bv)a(document).unbind(a.imgAreaSelect.keyPress,a.imgAreaSelect.onKeyPress);if(h.keys)a(document)[a.imgAreaSelect.keyPress](a.imgAreaSelect.onKeyPress=bv)}if(a.browser.msie&&m.outerWidth()-m.innerWidth()==2){m.css("margin",0);setTimeout(function(){m.css("margin","auto")},0)}}function be(){if(!i.width())return;s={left:e(i.offset().left),top:e(i.offset().top)};t=i.innerWidth();u=i.innerHeight();s.top+=i.outerHeight()-u>>1;s.left+=i.outerWidth()-t>>1;E=e(h.minWidth/B)||0;F=e(h.minHeight/C)||0;G=e(d(h.maxWidth/B||1<<24,t));H=e(d(h.maxHeight/C||1<<24,u));if(a().jquery=="1.3.2"&&y=="fixed"&&!P["getBoundingClientRect"]){s.top+=c(document.body.scrollTop,P.scrollTop);s.left+=c(document.body.scrollLeft,P.scrollLeft)}w=/absolute|relative/.test(v.css("position"))?{left:e(v.offset().left)-v.scrollLeft(),top:e(v.offset().top)-v.scrollTop()}:y=="fixed"?{left:a(document).scrollLeft(),top:a(document).scrollTop()}:{left:0,top:0};q=X(0);r=Y(0);if(O.x2>t||O.y2>u)bm()}function bd(a,b,c,d,f){var g=f||B,h=f||C;O={x1:e(a/g||0),y1:e(b/h||0),x2:e(c/g||0),y2:e(d/h||0)};O.width=O.x2-O.x1;O.height=O.y2-O.y1}function bc(a){var b=a||B,c=a||C;return{x1:e(O.x1*b),y1:e(O.y1*c),x2:e(O.x2*b),y2:e(O.y2*c),width:e(O.x2*b)-e(O.x1*b),height:e(O.y2*c)-e(O.y1*c)}}function bb(a){return a.pageY-w.top}function ba(a){return a.pageX-w.left}function _(a){return a-s.top+w.top}function Z(a){return a-s.left+w.left}function Y(a){return a+s.top-w.top}function X(a){return a+s.left-w.left}var i=a(g),j,k=f(),l=f(),m=f().add(f()).add(f()).add(f()),n=f().add(f()).add(f()).add(f()),o=a([]),p,q,r,s={left:0,top:0},t,u,v,w={left:0,top:0},x=0,y="absolute",z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O={x1:0,y1:0,x2:0,y2:0,width:0,height:0},P=document.documentElement,Q,R,S,T,U,V,W;var bv=function(a){var b=h.keys,e,f,g=a.keyCode;e=!isNaN(b.alt)&&(a.altKey||a.originalEvent.altKey)?b.alt:!isNaN(b.ctrl)&&a.ctrlKey?b.ctrl:!isNaN(b.shift)&&a.shiftKey?b.shift:!isNaN(b.arrows)?b.arrows:10;if(b.arrows=="resize"||b.shift=="resize"&&a.shiftKey||b.ctrl=="resize"&&a.ctrlKey||b.alt=="resize"&&(a.altKey||a.originalEvent.altKey)){switch(g){case 37:e=-e;case 39:f=c(K,M);K=d(K,M);M=c(f+e,K);bl();break;case 38:e=-e;case 40:f=c(L,N);L=d(L,N);N=c(f+e,L);bl(true);break;default:return}bm()}else{K=d(K,M);L=d(L,N);switch(g){case 37:bo(c(K-e,q),L);break;case 38:bo(K,c(L-e,r));break;case 39:bo(K+d(e,t-Z(M)),L);break;case 40:bo(K,L+d(e,u-_(N)));break;default:return}}return false};this.remove=function(){bx({disable:true});k.add(n).remove()};this.getOptions=function(){return h};this.setOptions=bx;this.getSelection=bc;this.setSelection=bd;this.cancelSelection=br;this.update=bg;Q=i;while(Q.length){x=c(x,!isNaN(Q.css("z-index"))?Q.css("z-index"):x);if(Q.css("position")=="fixed")y="fixed";Q=Q.parent(":not(body)")}x=h.zIndex||x;if(a.browser.msie)i.attr("unselectable","on");a.imgAreaSelect.keyPress=a.browser.msie||a.browser.safari?"keydown":"keypress";if(a.browser.opera)p=f().css({width:"100%",height:"100%",position:"absolute",zIndex:x+2||2});k.add(n).css({visibility:"hidden",position:y,overflow:"hidden",zIndex:x||"0"});k.css({zIndex:x+2||2});l.add(m).css({position:"absolute",fontSize:0});g.complete||g.readyState=="complete"||!i.is("img")?bu():i.one("load",bu);if(!j&&a.browser.msie&&a.browser.version>=7)g.src=g.src};a.fn.imgAreaSelect=function(b){b=b||{};this.each(function(){if(a(this).data("imgAreaSelect")){if(b.remove){a(this).data("imgAreaSelect").remove();a(this).removeData("imgAreaSelect")}else a(this).data("imgAreaSelect").setOptions(b)}else if(!b.remove){if(b.enable===undefined&&b.disable===undefined)b.enable=true;a(this).data("imgAreaSelect",new a.imgAreaSelect(this,b))}});if(b.instance)return a(this).data("imgAreaSelect");return this}})(jQuery)